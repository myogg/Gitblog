name: Generate GitBlog README

on:
  workflow_dispatch:
  issues:
    types: [opened, edited, reopened]
  issue_comment:
    types: [created, edited]
  push:
    branches:
      - master
    paths:
      - 'main.py'
      - '.github/workflows/*'
      - 'requirements.txt'

jobs:
  sync:
    name: Generate README
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æ·»åŠ å†™æƒé™
    
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event.issue && github.repository_owner_id == github.event.issue.user.id)
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨æ ‡å‡†token
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # ä½¿ç”¨æ›´ç¨³å®šçš„ç‰ˆæœ¬
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Create required directories
        run: |
          mkdir -p BACKUP
          
      - name: Generate README with debug
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_NAME: ${{ github.repository_owner }}
          GITHUB_EMAIL: "${{ github.repository_owner }}@users.noreply.github.com"
        run: |
          echo "=== Configuration ==="
          echo "Event: ${{ github.event_name }}"
          echo "Full repo: ${{ github.repository }}"
          
          # æå–ä»“åº“å
          REPO_ONLY=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "Repo name only: $REPO_ONLY"
          
          # è¿è¡Œè„šæœ¬
          if [[ "${{ github.event_name }}" == "issues" || "${{ github.event_name }}" == "issue_comment" ]]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
            echo "Processing issue #$ISSUE_NUM"
            python main.py "$GITHUB_TOKEN" "$REPO_ONLY" --issue_number "$ISSUE_NUM"
          else
            echo "Processing all issues"
            python main.py "$GITHUB_TOKEN" "$REPO_ONLY"
          fi
          
          echo "=== Checking generated files ==="
          ls -la README.md feed.xml BACKUP/ 2>/dev/null || echo "No files found"
          
      - name: Commit and push changes
        run: |
          # é…ç½®Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          echo "=== Checking for changes ==="
          git status
          git diff --name-only
          
          if git diff --quiet HEAD --; then
            echo "No changes to commit"
            exit 0
          fi
          
          # æ·»åŠ æ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶
          echo "=== Adding files ==="
          git add README.md feed.xml BACKUP/*.md 2>/dev/null || echo "No files to add"
          
          # æäº¤
          echo "=== Committing ==="
          git commit -m "ğŸ“š Auto-update: $(date +'%Y-%m-%d %H:%M:%S')" || echo "Nothing to commit"
          
          # æ¨é€
          echo "=== Pushing ==="
          git push origin master || echo "Push failed or nothing to push"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
