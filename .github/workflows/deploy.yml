name: Deploy GitHub Pages

on:
  workflow_dispatch:   # æ‰‹å‹•è§¸ç™¼
  issues:
    # åªç›£è½æ¨™ç±¤äº‹ä»¶ï¼Œé¿å…é‡è¤‡è§¸ç™¼
    types: [labeled]

permissions:
  contents: read
  pages: write
  id-token: write
  issues: write  # ä¿ç•™æƒé™ï¼Œä¾¿äºæœªæ¥æ‰©å±•

# ä½¿ç”¨å”¯ä¸€çš„ä½µç™¼çµ„ï¼Œç¢ºä¿åŒä¸€issueä¸æœƒåŒæ™‚éƒ¨ç½²
concurrency:
  group: "pages-deploy-${{ github.event.issue.number || 'manual' }}"
  cancel-in-progress: true

jobs:
  # é¦–å…ˆè¨˜éŒ„è§¸ç™¼ä¿¡æ¯
  log-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      trigger_type: ${{ steps.check.outputs.trigger_type }}
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          echo "äº‹ä»¶åç¨±: ${{ github.event_name }}"
          echo "äº‹ä»¶å‹•ä½œ: ${{ github.event.action }}"
          
          # å°æ–¼issueäº‹ä»¶ï¼Œæª¢æŸ¥æ¨™ç±¤
          if [[ "${{ github.event_name }}" == "issues" ]]; then
            echo "Issue è™Ÿç¢¼: ${{ github.event.issue.number }}"
            echo "Issue æ¨™é¡Œ: ${{ github.event.issue.title }}"
            echo "ç™¼èµ·è€…: ${{ github.event.issue.user.login }}"
            
            # ç²å–æ¨™ç±¤ä¿¡æ¯
            if [[ "${{ github.event.action }}" == "labeled" ]]; then
              echo "æ·»åŠ çš„æ¨™ç±¤: ${{ github.event.label.name }}"
              
              # åªæœ‰ç‰¹å®šæ¨™ç±¤æ‰è§¸ç™¼éƒ¨ç½²ï¼ˆå¯é¸ï¼‰
              # AUTO_DEPLOY_LABELS="deploy,auto-deploy,publish"
              # if [[ " $AUTO_DEPLOY_LABELS " =~ " ${{ github.event.label.name }} " ]]; then
              #   echo "âœ… æ¨™ç±¤ç¬¦åˆï¼Œè§¸ç™¼éƒ¨ç½²"
              #   echo "should_deploy=true" >> $GITHUB_OUTPUT
              #   echo "trigger_type=label_approved" >> $GITHUB_OUTPUT
              # else
              #   echo "â­ï¸ æ¨™ç±¤ä¸ç¬¦åˆï¼Œè·³ééƒ¨ç½²"
              #   echo "should_deploy=false" >> $GITHUB_OUTPUT
              #   echo "trigger_type=label_skipped" >> $GITHUB_OUTPUT
              # fi
              
              # æš«æ™‚æ‰€æœ‰labeledäº‹ä»¶éƒ½è§¸ç™¼
              echo "âœ… æ¨™ç±¤äº‹ä»¶ï¼Œè§¸ç™¼éƒ¨ç½²"
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "trigger_type=label_event" >> $GITHUB_OUTPUT
            else
              echo "â­ï¸ éæ¨™ç±¤äº‹ä»¶ï¼Œè·³ééƒ¨ç½²"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              echo "trigger_type=non_label_event" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "âœ… æ‰‹å‹•è§¸ç™¼éƒ¨ç½²"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "trigger_type=manual" >> $GITHUB_OUTPUT
          else
            echo "â“ æœªçŸ¥äº‹ä»¶é¡å‹"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "trigger_type=unknown" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: log-trigger
    # åªæœ‰åœ¨log-triggerç¢ºèªéœ€è¦éƒ¨ç½²æ™‚æ‰é‹è¡Œ
    if: needs.log-trigger.outputs.should_deploy == 'true'
    
    runs-on: ubuntu-latest
    environment:
      name: github-pages

    steps:
      - name: Show deployment info
        run: |
          echo "ğŸ¯ éƒ¨ç½²è§¸ç™¼é¡å‹: ${{ needs.log-trigger.outputs.trigger_type }}"
          echo "ğŸ“¦ é–‹å§‹ç”Ÿæˆéœæ…‹é é¢..."
          
          # å¦‚æœæ˜¯issueäº‹ä»¶ï¼Œé¡¯ç¤ºæ›´å¤šä¿¡æ¯
          if [[ "${{ github.event_name }}" == "issues" ]]; then
            echo "ğŸ“ Issue: #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
            echo "ğŸ‘¤ ç”± ${{ github.event.issue.user.login }} å‰µå»º"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install markdown PyGithub marko jinja2 feedgen

      - name: Generate HTML page
        env:
          G_TT: ${{ secrets.G_T }}
          # â–¼â–¼â–¼ å·²æ·»åŠ  Giscus ç¯å¢ƒå˜é‡é…ç½® â–¼â–¼â–¼
          GISCUS_REPO_ID: ${{ secrets.GISCUS_REPO_ID }}
          GISCUS_CATEGORY_ID: ${{ secrets.GISCUS_CATEGORY_ID }}
          # â–²â–²â–² â–²â–²â–² â–²â–²â–²
        run: |
          echo "é–‹å§‹ç”ŸæˆHTMLé é¢..."
          python generate_page.py
          
          echo "=== æ–‡ä»¶ç”Ÿæˆæª¢æŸ¥ ==="
          echo "ç•¶å‰ç›®éŒ„æ–‡ä»¶:"
          ls -la
          
          echo "æ–‡ç« ç›®éŒ„å…§å®¹:"
          ls -la articles/ 2>/dev/null || echo "articles/ ç›®éŒ„ä¸å­˜åœ¨"
          
          echo "éœæ…‹æ–‡ä»¶ç›®éŒ„å…§å®¹:"
          ls -la static/ 2>/dev/null || echo "static/ ç›®éŒ„ä¸å­˜åœ¨"
          
          # æª¢æŸ¥å¿…è¦æ–‡ä»¶
          if [ -f "index.html" ]; then
            echo "âœ… index.html å·²ç”Ÿæˆ"
          else
            echo "âŒ index.html æœªç”Ÿæˆ"
            exit 1
          fi
          
          # æ£€æŸ¥å…¶ä»–å¯èƒ½å­˜åœ¨çš„é¡µé¢
          if [ -f "search.html" ]; then
            echo "âœ… search.html å·²ç”Ÿæˆ"
          fi
          
          if [ -f "about.html" ]; then
            echo "âœ… about.html å·²ç”Ÿæˆ"
          fi
          
          # æª¢æŸ¥æ˜¯å¦æœ‰æ–‡ç« ç”Ÿæˆ
          article_count=$(find articles -name "*.html" 2>/dev/null | wc -l)
          if [ $article_count -gt 0 ]; then
            echo "âœ… å·²ç”Ÿæˆ $article_count ç¯‡æ–‡ç« "
          else
            echo "âš ï¸ æœªç”Ÿæˆä»»ä½•æ–‡ç« "
          fi

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

  # éƒ¨ç½²å¾Œé€šçŸ¥ï¼ˆå¯é¸ï¼‰
  notify:
    needs: deploy
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment result
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸŒ è¨ªå•åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          else
            echo "âŒ éƒ¨ç½²å¤±æ•—"
            echo "è«‹æŸ¥çœ‹å·¥ä½œæµæ—¥èªŒæ’æŸ¥å•é¡Œ"
          fi
