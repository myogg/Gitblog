<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}&lt;/&gt;北方的博客{% endblock %}</title>
    <meta name="description" content="{% block description %}<js/> - 记录技术、生活和思考。探索编程、人工智能、个人成长等话题。{% endblock %}">
    <meta name="keywords" content="{% block keywords %}博客,技术博客,编程,AI,个人成长{% endblock %}">
    <meta name="author" content="Jiang Sheng">

    <meta property="og:title" content="<js/>">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://134688.xyz/">
    <meta property="og:description" content="<js/> - 记录技术、生活和思考。探索编程、人工智能、个人成长等话题。">
    <meta property="og:site_name" content="<js/>">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% if base_path %}{{base_path}}{% endif %}static/style.css">

    {% block head_extra %}{% endblock %}

    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Blog",
        "name": "<js/>",
        "description": "记录技术、生活和思考。探索编程、人工智能、个人成长等话题。",
        "url": "https://134688.xyz",
        "inLanguage": "zh-CN",
        "author": {
            "@type": "Person",
            "name": "Jiang Sheng",
            "url": "https://134688.xyz/about.html",
            "sameAs": [
                "https://github.com/myogg",
                "https://www.facebook.com/lengyu.jiang"
            ]
        }
    }
    </script>
</head>
<body data-theme="light">
    <header class="site-header">
        <div class="header-content">
            <a href="{% if base_path %}{{base_path}}{% endif %}index.html" class="site-logo">&lt;js/&gt;</a>
            <div class="header-right">
                <div class="dropdown">
                    <button class="dropdown-toggle" id="menuToggle">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <line x1="3" y1="8" x2="21" y2="8"></line>
                            <line x1="3" y1="16" x2="21" y2="16"></line>
                        </svg>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="{% if base_path %}{{base_path}}{% endif %}index.html">博客</a>
                        <a href="{% if base_path %}{{base_path}}{% endif %}search.html">搜索</a>
                        <a href="{% if base_path %}{{base_path}}{% endif %}about.html">关于</a>
                    </div>
                </div>
                <button class="theme-toggle" id="themeToggle" aria-label="切换主题">
                    <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- 实时通知栏 -->
    <div id="live-notification" class="notification-bar" style="display: none;"></div>

    <main class="container">
        {% block content %}
        <h1 class="page-heading">博客</h1>

        <div class="main-layout">
            <div class="main-content">
                <div class="articles-container" id="articles-container">
                    <!-- 文章会通过流式加载 -->
                    <div class="loading-spinner">加载文章中...</div>
                </div>

                {% if pagination %}
                <nav class="pagination" id="pagination">
                    <div>
                        {% if pagination.prev_page %}
                        <a href="{{pagination.prev_page}}" class="page-link">&larr; 上一页</a>
                        {% endif %}
                    </div>
                    <span class="page-info">第 {{pagination.current_page}} / {{pagination.total_pages}} 页</span>
                    <div>
                        {% if pagination.next_page %}
                        <a href="{{pagination.next_page}}" class="page-link">下一页 &rarr;</a>
                        {% endif %}
                    </div>
                </nav>
                {% endif %}
            </div>

            <aside class="sidebar">
                <div class="subscribe-card">
                    <div class="subscribe-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 11a9 9 0 0 1 9 9"></path>
                            <path d="M4 4a16 16 0 0 1 16 16"></path>
                            <circle cx="5" cy="19" r="1"></circle>
                        </svg>
                    </div>
                    <h3 class="subscribe-title">订阅我的博客</h3>
                    <p class="subscribe-description">可以通过 <strong>Feedly</strong>, <strong>Inoreader</strong> 或 <strong>RSS</strong> 订阅。RSS 地址：</p>
                    <div class="subscribe-url-box">
                        <input type="text" readonly value="https://134688.xyz/feed.xml" class="subscribe-url-input" id="rssUrl">
                    </div>
                    <button class="subscribe-button" onclick="copyRssUrl()">订阅</button>
                </div>

                <!-- 实时统计卡片 -->
                <div class="stats-card" id="live-stats">
                    <h4>实时统计</h4>
                    <div class="stat-item">
                        <span>在线访客:</span>
                        <span class="stat-value" id="online-count">加载中...</span>
                    </div>
                    <div class="stat-item">
                        <span>今日阅读:</span>
                        <span class="stat-value" id="today-views">加载中...</span>
                    </div>
                </div>
            </aside>
        </div>
        {% endblock %}
    </main>

    <footer class="site-footer">
        <div class="footer-logo">&lt;js/&gt;</div>
        <div class="footer-copyright">© {{YEAR}} Designed and developed by Jiang Sheng</div>
    </footer>

    <button class="back-to-top" id="backToTop" aria-label="返回顶部">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="18 15 12 9 6 15"></polyline>
        </svg>
    </button>

    <!-- 添加 jsonriver 和全局流式功能 -->
    <script type="module">
        import { parse } from 'https://unpkg.com/jsonriver?module';

        // ========== 全局配置 ==========
        const API_BASE = 'https://api.134688.xyz'; // 替换为你的API地址
        const STREAM_ENDPOINTS = {
            notifications: `${API_BASE}/notifications/stream`,
            stats: `${API_BASE}/stats/live`,
            articles: `${API_BASE}/articles/stream`,
            search: `${API_BASE}/search/stream`
        };

        // ========== 实时通知 ==========
        class NotificationManager {
            constructor() {
                this.notificationBar = document.getElementById('live-notification');
                this.activeNotifications = new Set();
            }

            async start() {
                try {
                    const response = await fetch(STREAM_ENDPOINTS.notifications);
                    const stream = parse(response.body.pipeThrough(new TextDecoderStream()));
                    
                    for await (const notif of stream) {
                        this.showNotification(notif);
                    }
                } catch (error) {
                    console.log('通知流断开，5秒后重连:', error);
                    setTimeout(() => this.start(), 5000);
                }
            }

            showNotification(notif) {
                if (this.activeNotifications.has(notif.id)) return;
                
                this.activeNotifications.add(notif.id);
                this.notificationBar.style.display = 'block';
                this.notificationBar.textContent = notif.message;
                this.notificationBar.className = `notification-bar ${notif.type || 'info'}`;

                // 5秒后自动关闭
                setTimeout(() => {
                    this.notificationBar.style.display = 'none';
                    this.activeNotifications.delete(notif.id);
                }, 5000);
            }
        }

        // ========== 实时统计 ==========
        class StatsManager {
            constructor() {
                this.onlineCount = document.getElementById('online-count');
                this.todayViews = document.getElementById('today-views');
            }

            async start() {
                try {
                    const response = await fetch(STREAM_ENDPOINTS.stats);
                    const stream = parse(response.body.pipeThrough(new TextDecoderStream()));
                    
                    for await (const stat of stream) {
                        this.updateStats(stat);
                    }
                } catch (error) {
                    console.log('统计流断开，5秒后重连:', error);
                    setTimeout(() => this.start(), 5000);
                }
            }

            updateStats(stat) {
                if (stat.type === 'online' && this.onlineCount) {
                    this.onlineCount.textContent = stat.count;
                    this.onlineCount.classList.add('pulse');
                    setTimeout(() => this.onlineCount.classList.remove('pulse'), 300);
                } else if (stat.type === 'views' && this.todayViews) {
                    this.todayViews.textContent = stat.count;
                }
            }
        }

        // ========== 文章流式加载 ==========
        class ArticleStreamManager {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.page = 1;
                this.loading = false;
                this.hasMore = true;
            }

            async loadMore() {
                if (this.loading || !this.hasMore) return;
                
                this.loading = true;
                this.showLoader();

                try {
                    const response = await fetch(`${STREAM_ENDPOINTS.articles}?page=${this.page}`);
                    const stream = parse(response.body.pipeThrough(new TextDecoderStream()));
                    
                    let count = 0;
                    for await (const article of stream) {
                        count++;
                        this.appendArticle(article);
                    }

                    if (count === 0) {
                        this.hasMore = false;
                        this.hideLoader();
                    } else {
                        this.page++;
                        this.loading = false;
                        this.hideLoader();
                    }
                } catch (error) {
                    console.error('加载文章失败:', error);
                    this.loading = false;
                    this.hideLoader();
                }
            }

            appendArticle(article) {
                if (!this.container) return;

                const articleEl = document.createElement('article');
                articleEl.className = 'article-card fade-in';
                articleEl.innerHTML = `
                    <h2 class="article-card-title">
                        <a href="articles/article-${article.number}.html">${this.escapeHtml(article.title)}</a>
                    </h2>
                    ${article.summary ? `<p class="article-card-summary">${this.escapeHtml(article.summary)}</p>` : ''}
                    <time class="article-card-date">${article.date}</time>
                `;
                
                this.container.appendChild(articleEl);
            }

            showLoader() {
                if (!document.getElementById('stream-loader')) {
                    const loader = document.createElement('div');
                    loader.id = 'stream-loader';
                    loader.className = 'stream-loader';
                    loader.innerHTML = '<span class="spinner"></span> 加载更多...';
                    this.container.appendChild(loader);
                }
            }

            hideLoader() {
                const loader = document.getElementById('stream-loader');
                if (loader) loader.remove();
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // ========== 初始化 ==========
        document.addEventListener('DOMContentLoaded', () => {
            // 启动通知
            const notifManager = new NotificationManager();
            notifManager.start();

            // 启动统计
            const statsManager = new StatsManager();
            statsManager.start();

            // 文章流式加载（如果在首页）
            if (document.getElementById('articles-container')) {
                const articleStream = new ArticleStreamManager('articles-container');
                
                // 初始加载
                articleStream.loadMore();

                // 滚动加载
                window.addEventListener('scroll', () => {
                    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
                        articleStream.loadMore();
                    }
                });
            }

            // 主题切换
            const themeToggle = document.getElementById('themeToggle');
            const bodyEl = document.body;
            const savedTheme = localStorage.getItem('theme') || 'light';
            bodyEl.setAttribute('data-theme', savedTheme);

            themeToggle.addEventListener('click', () => {
                const currentTheme = bodyEl.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                bodyEl.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // 通知 Waline 主题变化
                if (window.walineInstance) {
                    window.walineInstance.update({
                        dark: newTheme === 'dark'
                    });
                }
            });

            // 下拉菜单
            const menuToggle = document.getElementById('menuToggle');
            const dropdownMenu = document.getElementById('dropdownMenu');

            menuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('show');
            });

            document.addEventListener('click', () => {
                dropdownMenu.classList.remove('show');
            });

            // 返回顶部
            const backToTopButton = document.getElementById('backToTop');

            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    backToTopButton.classList.add('show');
                } else {
                    backToTopButton.classList.remove('show');
                }
            });

            backToTopButton.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });

        // 复制RSS地址
        window.copyRssUrl = function() {
            const urlInput = document.getElementById('rssUrl');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);

            navigator.clipboard.writeText(urlInput.value).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '已复制!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(() => {
                document.execCommand('copy');
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '已复制!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        };
    </script>

    <style>
        /* 添加流式加载相关样式 */
        .notification-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 0.75rem;
            text-align: center;
            z-index: 1000;
            animation: slideDown 0.3s ease;
        }

        .notification-bar.info {
            background: #3b82f6;
            color: white;
        }

        .notification-bar.success {
            background: #10b981;
            color: white;
        }

        .notification-bar.warning {
            background: #f59e0b;
            color: white;
        }

        .notification-bar.error {
            background: #ef4444;
            color: white;
        }

        .stats-card {
            margin-top: 2rem;
            padding: 1.25rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
        }

        .stats-card h4 {
            margin-bottom: 1rem;
            font-size: 0.9375rem;
            color: var(--text-primary);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 500;
            color: var(--text-primary);
        }

        .stat-value.pulse {
            animation: pulse 0.3s ease;
        }

        .stream-loader {
            text-align: center;
            padding: 2rem;
            color: var(--text-tertiary);
        }

        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--border-color);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 0.5rem;
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</body>
</html>
