{% extends "base.html" %}

{% block title %}{{issue.title}} - &lt;/&gt;åŒ—æ–¹çš„åšå®¢{% endblock %}

{% block description %}{% if issue.summary %}{{issue.summary[:200]}}{% else %}</>åŒ—æ–¹çš„åšå®¢ - {{issue.title}}ã€‚è®°å½•æŠ€æœ¯ã€ç”Ÿæ´»å’Œæ€è€ƒã€‚{% endif %}{% endblock %}

{% block keywords %}{% for label in labels_data %}{{label.name}}{% if not loop.last %},{% endif %}{% endfor %}{% if content_tags %}{% for tag in content_tags %},{{tag.name}}{% endfor %}{% endif %}{% endblock %}

{% block head_extra %}
<!-- DNS é¢„è¿æ¥ - åŠ é€Ÿ CDN èµ„æºåŠ è½½ -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<link rel="dns-prefetch" href="https://waline.134688.xyz">

<!-- ========== Open Graph Meta Tags ========== -->
<meta property="og:title" content="{{issue.title}}">
<meta property="og:description" content="{% if issue.summary %}{{issue.summary[:150]}}{% else %}<js/> - è®°å½•æŠ€æœ¯ã€ç”Ÿæ´»å’Œæ€è€ƒ{% endif %}">
<meta property="og:type" content="article">
<meta property="og:url" content="https://134688.xyz/articles/article-{{issue.number}}.html">

<!-- å›¾ç‰‡ -->
<meta property="og:image" content="https://134688.xyz/static/og-default.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:type" content="image/png">
<meta property="og:image:alt" content="{{issue.title}} - <js/>">

<meta property="og:site_name" content="<js/>">
<meta property="fb:app_id" content="100006838422002">

<!-- æ–‡ç« ä½œè€…ä¿¡æ¯ -->
<meta property="article:author" content="https://www.facebook.com/lengyu.jiang">
<meta property="article:author:username" content="lengyu.jiang">
<meta property="fb:profile_id" content="100006838422002">

<!-- æ–‡ç« å…ƒæ•°æ® -->
<meta property="article:published_time" content="{{issue.created_at.isoformat()}}">
<meta property="article:modified_time" content="{{issue.created_at.isoformat()}}">
{% for label in labels_data %}
<meta property="article:tag" content="{{label.name}}">
{% endfor %}

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{issue.title}}">
<meta name="twitter:description" content="{% if issue.summary %}{{issue.summary[:150]}}{% else %}<js/> - è®°å½•æŠ€æœ¯ã€ç”Ÿæ´»å’Œæ€è€ƒ{% endif %}">
<meta name="twitter:image" content="https://134688.xyz/static/og-default.png">
<!-- ========== Open Graphç»“æŸ ========== -->

<!-- GitHub Markdown CSS - ä½¿ç”¨jsDelivrå›½å†…åŠ é€Ÿ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown-light.min.css">
<!-- Pygments ä»£ç é«˜äº®æ ·å¼ - github ä¸»é¢˜ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pygments-css@1.0.0/github.min.css">
<!-- Waline æ ·å¼ - ä½¿ç”¨å›½å†…CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@waline/client@3/dist/waline.min.css">

<!-- Structured Data - Blog Posting -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "{{issue.title}}",
    "description": "{% if issue.summary %}{{issue.summary[:200]}}{% else %}{{issue.title}}{% endif %}",
    "image": "https://134688.xyz/static/og-default.png",
    "datePublished": "{{issue.created_at.isoformat()}}",
    "dateModified": "{{issue.created_at.isoformat()}}",
    "author": {
        "@type": "Person",
        "name": "Jiang Sheng",
        "url": "https://134688.xyz/about.html"
    },
    "publisher": {
        "@type": "Person",
        "name": "Jiang Sheng"
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://134688.xyz/articles/article-{{issue.number}}.html"
    },
    "keywords": "{% for label in labels_data %}{{label.name}}{% if not loop.last %}, {% endif %}{% endfor %}{% if content_tags %}{% for tag in content_tags %}, {{tag.name}}{% endfor %}{% endif %}",
    "articleSection": "{% if labels_data %}{{labels_data[0].name}}{% else %}åšå®¢{% endif %}",
    "inLanguage": "zh-CN"
}
</script>

<!-- Structured Data - BreadcrumbList -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
        {
            "@type": "ListItem",
            "position": 1,
            "name": "é¦–é¡µ",
            "item": "https://134688.xyz/"
        },
        {
            "@type": "ListItem",
            "position": 2,
            "name": "{{issue.title}}",
            "item": "https://134688.xyz/articles/article-{{issue.number}}.html"
        }
    ]
}
</script>

<style>
    /* æ–‡ç« é¡µé¢ä¸“å±æ ·å¼ */
    .article-header {
        margin-bottom: 2.5rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--border-color);
    }

    .article-title-text {
        font-size: 2.25rem;
        font-weight: 600;
        line-height: 1.3;
        margin-bottom: 1rem;
        color: var(--text-primary);
        letter-spacing: -0.02em;
    }

    .article-meta {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 1.25rem;
        flex-wrap: wrap;
    }

    .post-date {
        font-family: var(--font-mono);
        font-size: 0.875rem;
        color: var(--text-tertiary);
    }

    /* GitHubæ ‡ç­¾æ ·å¼ */
    .article-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .tag {
        display: inline-block;
        padding: 0.375rem 0.875rem;
        border-radius: 1.5rem;
        font-size: 0.8125rem;
        font-weight: 500;
        color: white;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .tag:hover {
        opacity: 0.85;
        transform: translateY(-1px);
    }

    .content-tag {
        display: inline-block;
        padding: 0.375rem 0.875rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 1.5rem;
        font-size: 0.8125rem;
        color: var(--text-secondary);
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .content-tag:hover {
        background: var(--bg-hover);
        border-color: var(--border-hover);
        color: var(--text-primary);
    }

    /* æ–‡ç« å†…å®¹åŒº */
    .content-area {
        font-size: 1rem;
        line-height: 1.8;
        color: var(--text-primary);
    }

    /* Markdown æ ·å¼é€‚é…æš—é»‘æ¨¡å¼ */
    body[data-theme="dark"] .markdown-body {
        color-scheme: dark;
        background-color: transparent !important;
        color: var(--text-primary) !important;
    }

    body[data-theme="dark"] .content-area {
        color: var(--text-primary);
    }

    /* æš—é»‘æ¨¡å¼ä¸‹çš„ Markdown å…ƒç´ æ ·å¼ */
    body[data-theme="dark"] .markdown-body h1,
    body[data-theme="dark"] .markdown-body h2,
    body[data-theme="dark"] .markdown-body h3,
    body[data-theme="dark"] .markdown-body h4,
    body[data-theme="dark"] .markdown-body h5,
    body[data-theme="dark"] .markdown-body h6 {
        color: var(--text-primary) !important;
        border-bottom-color: var(--border-color) !important;
    }

    body[data-theme="dark"] .markdown-body a {
        color: #58a6ff !important;
    }

    body[data-theme="dark"] .markdown-body a:hover {
        color: #79c0ff !important;
    }

    body[data-theme="dark"] .markdown-body blockquote {
        color: var(--text-secondary) !important;
        border-left-color: var(--border-color) !important;
    }

    body[data-theme="dark"] .markdown-body hr {
        background-color: var(--border-color) !important;
        border: none !important;
    }

    body[data-theme="dark"] .markdown-body table tr {
        background-color: transparent !important;
        border-top-color: var(--border-color) !important;
    }

    body[data-theme="dark"] .markdown-body table tr:nth-child(2n) {
        background-color: var(--bg-secondary) !important;
    }

    body[data-theme="dark"] .markdown-body table th,
    body[data-theme="dark"] .markdown-body table td {
        border-color: var(--border-color) !important;
    }

    body[data-theme="dark"] .markdown-body img {
        background-color: transparent !important;
    }

    body[data-theme="dark"] .markdown-body ul,
    body[data-theme="dark"] .markdown-body ol {
        color: var(--text-primary) !important;
    }

    body[data-theme="dark"] .markdown-body li {
        color: var(--text-primary) !important;
    }

    body[data-theme="dark"] .markdown-body strong {
        color: var(--text-primary) !important;
    }

    body[data-theme="dark"] .markdown-body em {
        color: var(--text-primary) !important;
    }

    body[data-theme="dark"] .markdown-body p {
        color: var(--text-primary) !important;
    }

    body[data-theme="dark"] .markdown-body pre {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
    }

    body[data-theme="dark"] .markdown-body code {
        background-color: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
    }

    /* æ–‡ç« å¯¼èˆª */
    .article-navigation {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin: 4rem 0 3rem;
        padding-top: 3rem;
        border-top: 1px solid var(--border-color);
    }

    .nav-item {
        padding: 1.25rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        transition: all 0.2s ease;
    }

    .nav-item:hover {
        background: var(--bg-hover);
        border-color: var(--border-hover);
        transform: translateY(-2px);
    }

    .nav-item.next {
        text-align: right;
    }

    .nav-label {
        display: block;
        font-size: 0.75rem;
        color: var(--text-tertiary);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .nav-title {
        display: block;
        color: var(--text-primary);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9375rem;
        transition: color 0.2s ease;
    }

    .nav-title:hover {
        color: var(--text-secondary);
    }

    /* ç›¸å…³æ–‡ç«  */
    .related-articles {
        margin: 3rem 0;
        padding: 1.5rem;
        background: var(--bg-secondary);
        border-radius: 0.75rem;
        border: 1px solid var(--border-color);
    }

    .related-articles h3 {
        font-size: 1rem;
        font-weight: 500;
        margin-bottom: 1rem;
        color: var(--text-primary);
    }

    .related-list {
        list-style: none;
        padding: 0;
    }

    .related-list li {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .related-list li:last-child {
        border-bottom: none;
    }

    .related-list a {
        color: var(--text-primary);
        text-decoration: none;
        font-size: 0.9375rem;
        transition: color 0.2s ease;
        flex: 1;
    }

    .related-list a:hover {
        color: var(--text-secondary);
    }

    .related-date {
        font-family: var(--font-mono);
        font-size: 0.8125rem;
        color: var(--text-tertiary);
        margin-left: 1rem;
    }

    /* è¯„è®ºåŒº */
    .comment-section {
        margin-top: 4rem;
        padding-top: 3rem;
        border-top: 1px solid var(--border-color);
    }

    .comment-section h3 {
        font-size: 1.125rem;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
    }

    /* è¿”å›æŒ‰é’® */
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        padding: 0.5rem 0.875rem;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .back-link:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    /* ä»£ç å—æ ·å¼ */
    .markdown-body .codehilite,
    .markdown-body pre {
        position: relative;
        background: var(--bg-secondary) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 0.5rem !important;
        padding: 1rem !important;
        margin: 1rem 0 !important;
        overflow-x: auto;
        font-size: 0.875rem !important;
        line-height: 1.6 !important;
    }

    .markdown-body code {
        background: var(--bg-secondary) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 0.25rem !important;
        padding: 0.125rem 0.375rem !important;
        font-size: 0.875em !important;
        font-family: var(--font-mono) !important;
    }

    .markdown-body .codehilite code,
    .markdown-body pre code {
        background: transparent !important;
        border: none !important;
        padding: 0 !important;
    }

    /* ä»£ç å¤åˆ¶æŒ‰é’® */
    .copy-code-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        cursor: pointer;
        opacity: 0;
        transition: all 0.2s;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .codehilite:hover .copy-code-btn,
    pre:hover .copy-code-btn {
        opacity: 1;
    }

    .copy-code-btn:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .copy-code-btn.copied {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }

    /* å›¾ç‰‡æ ·å¼ */
    .markdown-body .content-area img {
        cursor: zoom-in;
        border-radius: 0.5rem;
        transition: opacity 0.3s, transform 0.3s;
        max-width: 100%;
        height: auto;
    }

    .markdown-body .content-area img:hover {
        opacity: 0.9;
        transform: scale(1.01);
    }

    /* å›¾ç‰‡æ‡’åŠ è½½çŠ¶æ€ */
    .markdown-body .content-area img.img-loading {
        background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-hover) 50%, var(--bg-secondary) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        min-height: 200px;
    }

    .markdown-body .content-area img.img-loaded {
        animation: fadeIn 0.5s ease-in;
    }

    .markdown-body .content-area img.img-error {
        border: 2px dashed var(--border-color);
        background: var(--bg-secondary);
        padding: 2rem;
        min-height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .markdown-body .content-area img.img-error::after {
        content: 'å›¾ç‰‡åŠ è½½å¤±è´¥';
        position: absolute;
        color: var(--text-tertiary);
        font-size: 0.875rem;
        font-family: var(--font-sans);
    }

    /* éª¨æ¶å±åŠ¨ç”» */
    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* æ·¡å…¥åŠ¨ç”» */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .medium-zoom-image--opened {
        cursor: zoom-out;
    }

    .medium-zoom-overlay {
        z-index: 9998;
        background: rgba(0, 0, 0, 0.9) !important;
    }

    .medium-zoom-image {
        z-index: 9999;
    }

    /* Waline æ ·å¼é€‚é… */
    .wl-container {
        font-family: var(--font-sans) !important;
    }

    body[data-theme="dark"] .wl-editor {
        background: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }

    body[data-theme="dark"] .wl-editor textarea {
        color: var(--text-primary) !important;
    }

    body[data-theme="dark"] .wl-card {
        background: transparent !important;
        border-color: var(--border-color) !important;
    }

    body[data-theme="dark"] .wl-content {
        color: var(--text-primary) !important;
    }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
        .article-title-text {
            font-size: 1.75rem;
        }

        .article-navigation {
            grid-template-columns: 1fr;
        }

        .nav-item.next {
            text-align: left;
        }

        .related-list li {
            flex-direction: column;
            gap: 0.25rem;
        }

        .related-date {
            margin-left: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<a href="../index.html" class="back-link">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
    è¿”å›é¦–é¡µ
</a>

<article>
    <header class="article-header">
        <h1 class="article-title-text">{{issue.title}}</h1>

        <div class="article-meta">
            <time class="post-date">{{issue.created_at.strftime('%B %d, %Y')}}</time>
        </div>

        <div class="article-tags">
            {% for l in labels_data %}
            <a href="../tags/{{l.safe_name}}.html" class="tag" style="background-color: #{{l.color}};">
                {{l.name}}
            </a>
            {% endfor %}

            {% if content_tags %}
            {% for tag in content_tags %}
            {% if tag.safe_name %}
            <a href="../tags/{{tag.safe_name}}.html" class="content-tag">
                {{tag.name}}
            </a>
            {% else %}
            <span class="content-tag">{{tag.name}}</span>
            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </header>

    <div class="markdown-body content-area">
        {{content|safe}}
    </div>
</article>

<!-- æ–‡ç« å¯¼èˆª -->
{% if prev_article or next_article %}
<nav class="article-navigation">
    {% if prev_article %}
    <div class="nav-item">
        <span class="nav-label">â† ä¸Šä¸€ç¯‡</span>
        <a href="article-{{prev_article.number}}.html" class="nav-title">{{prev_article.title}}</a>
    </div>
    {% else %}
    <div></div>
    {% endif %}

    {% if next_article %}
    <div class="nav-item next">
        <span class="nav-label">ä¸‹ä¸€ç¯‡ â†’</span>
        <a href="article-{{next_article.number}}.html" class="nav-title">{{next_article.title}}</a>
    </div>
    {% endif %}
</nav>
{% endif %}

<!-- ç›¸å…³æ–‡ç«  -->
{% if related_articles %}
<aside class="related-articles">
    <h3>ç›¸å…³æ–‡ç« </h3>
    <ul class="related-list">
        {% for article in related_articles %}
        <li>
            <a href="article-{{article.number}}.html">{{article.title}}</a>
            <span class="related-date">{{article.created_at.strftime('%Y-%m-%d')}}</span>
        </li>
        {% endfor %}
    </ul>
</aside>
{% endif %}

<!-- Walineè¯„è®ºåŒº -->
<section class="comment-section">
    <h3>ğŸ’¬ ç•™è¨€åŒº</h3>
    <div id="waline-container"></div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // å›¾ç‰‡æ‡’åŠ è½½åŠŸèƒ½
        const lazyImages = document.querySelectorAll('img.lazyload');

        if ('IntersectionObserver' in window) {
            // ä½¿ç”¨ Intersection Observer API å®ç°æ‡’åŠ è½½
            const imageObserver = new IntersectionObserver(function(entries, observer) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const src = img.getAttribute('data-src');

                        if (src) {
                            // åˆ›å»ºæ–°çš„Imageå¯¹è±¡é¢„åŠ è½½
                            const tempImg = new Image();

                            tempImg.onload = function() {
                                img.src = src;
                                img.classList.remove('img-loading');
                                img.classList.add('img-loaded');
                                img.removeAttribute('data-src');
                            };

                            tempImg.onerror = function() {
                                img.classList.remove('img-loading');
                                img.classList.add('img-error');
                                img.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', src);
                            };

                            tempImg.src = src;
                        }

                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px', // æå‰50pxå¼€å§‹åŠ è½½
                threshold: 0.01
            });

            lazyImages.forEach(function(img) {
                imageObserver.observe(img);
            });
        } else {
            // é™çº§æ–¹æ¡ˆï¼šç›´æ¥åŠ è½½æ‰€æœ‰å›¾ç‰‡
            lazyImages.forEach(function(img) {
                const src = img.getAttribute('data-src');
                if (src) {
                    img.src = src;
                    img.classList.remove('img-loading');
                    img.classList.add('img-loaded');
                }
            });
        }

        // ä»£ç å—å¤åˆ¶åŠŸèƒ½
        const codeBlocks = document.querySelectorAll('.codehilite, pre');

        codeBlocks.forEach(function(codeBlock) {
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-code-btn';
            copyBtn.textContent = 'å¤åˆ¶';

            codeBlock.style.position = 'relative';
            codeBlock.insertBefore(copyBtn, codeBlock.firstChild);

            copyBtn.addEventListener('click', function() {
                const codeElement = codeBlock.querySelector('code') || codeBlock;
                const codeText = codeElement.textContent;

                navigator.clipboard.writeText(codeText).then(function() {
                    copyBtn.textContent = 'å·²å¤åˆ¶ âœ“';
                    copyBtn.classList.add('copied');

                    setTimeout(function() {
                        copyBtn.textContent = 'å¤åˆ¶';
                        copyBtn.classList.remove('copied');
                    }, 2000);
                }).catch(function(err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    copyBtn.textContent = 'å¤åˆ¶å¤±è´¥';
                    setTimeout(function() {
                        copyBtn.textContent = 'å¤åˆ¶';
                    }, 2000);
                });
            });
        });
    });
</script>

<!-- Waline è¯„è®ºç³»ç»Ÿ - ä½¿ç”¨å›½å†…CDN -->
<script type="module">
    import { init } from 'https://cdn.jsdelivr.net/npm/@waline/client@3/dist/waline.min.js';

    init({
        el: '#waline-container',
        serverURL: 'https://waline.134688.xyz',
        lang: 'zh-CN',
        locale: {
            placeholder: 'ç•™ä¸‹ä½ çš„è¶³è¿¹å§ï½ (æ”¯æŒ Markdown è¯­æ³•)',
        },
        login: 'disable',
        dark: document.body.getAttribute('data-theme') === 'dark',
        meta: ['nick'],
        requiredMeta: ['nick'],
        pageSize: 10,
        wordLimit: 0,
        pageview: true,
        comment: true,
        copyright: false,
        reaction: true,
    });
</script>

<!-- Medium-zoom å›¾ç‰‡ç¼©æ”¾ - ä½¿ç”¨å›½å†…CDN -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script>
<script>
    mediumZoom('.content-area img', {
        margin: 24,
        background: 'rgba(0, 0, 0, 0.9)',
        scrollOffset: 0,
    });
</script>
{% endblock %}
