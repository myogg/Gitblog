{% extends "base.html" %}

{% block title %}{{issue.title}} - &lt;/&gt;åŒ—æ–¹çš„åšå®¢{% endblock %}

{% block description %}{% if issue.summary %}{{issue.summary[:200]}}{% else %}</>åŒ—æ–¹çš„åšå®¢ - {{issue.title}}ã€‚è®°å½•æŠ€æœ¯ã€ç”Ÿæ´»å’Œæ€è€ƒã€‚{% endif %}{% endblock %}

{% block keywords %}{% for label in labels_data %}{{label.name}}{% if not loop.last %},{% endif %}{% endfor %}{% if content_tags %}{% for tag in content_tags %},{{tag.name}}{% endfor %}{% endif %}{% endblock %}

{% block head_extra %}
<!-- DNS é¢„è¿æ¥ - åŠ é€Ÿ CDN èµ„æºåŠ è½½ -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<link rel="dns-prefetch" href="https://waline.134688.xyz">

<!-- ========== Open Graph Meta Tags ========== -->
<meta property="og:title" content="{{issue.title}}">
<meta property="og:description" content="{% if issue.summary %}{{issue.summary[:150]}}{% else %}<js/> - è®°å½•æŠ€æœ¯ã€ç”Ÿæ´»å’Œæ€è€ƒ{% endif %}">
<meta property="og:type" content="article">
<meta property="og:url" content="https://134688.xyz/articles/article-{{issue.number}}.html">

<!-- å›¾ç‰‡ -->
<meta property="og:image" content="https://134688.xyz/static/og-default.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:type" content="image/png">
<meta property="og:image:alt" content="{{issue.title}} - <js/>">

<meta property="og:site_name" content="<js/>">
<meta property="fb:app_id" content="100006838422002">

<!-- æ–‡ç« ä½œè€…ä¿¡æ¯ -->
<meta property="article:author" content="https://www.facebook.com/lengyu.jiang">
<meta property="article:author:username" content="lengyu.jiang">
<meta property="fb:profile_id" content="100006838422002">

<!-- æ–‡ç« å…ƒæ•°æ® -->
<meta property="article:published_time" content="{{issue.created_at.isoformat()}}">
<meta property="article:modified_time" content="{{issue.created_at.isoformat()}}">
{% for label in labels_data %}
<meta property="article:tag" content="{{label.name}}">
{% endfor %}

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{issue.title}}">
<meta name="twitter:description" content="{% if issue.summary %}{{issue.summary[:150]}}{% else %}<js/> - è®°å½•æŠ€æœ¯ã€ç”Ÿæ´»å’Œæ€è€ƒ{% endif %}">
<meta name="twitter:image" content="https://134688.xyz/static/og-default.png">
<!-- ========== Open Graphç»“æŸ ========== -->

<!-- GitHub Markdown CSS - ä½¿ç”¨jsDelivrå›½å†…åŠ é€Ÿ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown-light.min.css">
<!-- Pygments ä»£ç é«˜äº®æ ·å¼ - github ä¸»é¢˜ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pygments-css@1.0.0/github.min.css">
<!-- Waline æ ·å¼ - ä½¿ç”¨å›½å†…CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@waline/client@3/dist/waline.min.css">

<!-- Structured Data - Blog Posting -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "{{issue.title}}",
    "description": "{% if issue.summary %}{{issue.summary[:200]}}{% else %}{{issue.title}}{% endif %}",
    "image": "https://134688.xyz/static/og-default.png",
    "datePublished": "{{issue.created_at.isoformat()}}",
    "dateModified": "{{issue.created_at.isoformat()}}",
    "author": {
        "@type": "Person",
        "name": "Jiang Sheng",
        "url": "https://134688.xyz/about.html"
    },
    "publisher": {
        "@type": "Person",
        "name": "Jiang Sheng"
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://134688.xyz/articles/article-{{issue.number}}.html"
    },
    "keywords": "{% for label in labels_data %}{{label.name}}{% if not loop.last %}, {% endif %}{% endfor %}{% if content_tags %}{% for tag in content_tags %}, {{tag.name}}{% endfor %}{% endif %}",
    "articleSection": "{% if labels_data %}{{labels_data[0].name}}{% else %}åšå®¢{% endif %}",
    "inLanguage": "zh-CN"
}
</script>

<!-- Structured Data - BreadcrumbList -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
        {
            "@type": "ListItem",
            "position": 1,
            "name": "é¦–é¡µ",
            "item": "https://134688.xyz/"
        },
        {
            "@type": "ListItem",
            "position": 2,
            "name": "{{issue.title}}",
            "item": "https://134688.xyz/articles/article-{{issue.number}}.html"
        }
    ]
}
</script>

<style>
    /* æ–‡ç« é¡µé¢ä¸“å±æ ·å¼ */
    .article-header {
        margin-bottom: 2.5rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--border-color);
    }

    .article-title-text {
        font-size: 2.25rem;
        font-weight: 600;
        line-height: 1.3;
        margin-bottom: 1rem;
        color: var(--text-primary);
        letter-spacing: -0.02em;
    }

    .article-meta {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 1.25rem;
        flex-wrap: wrap;
    }

    .post-date {
        font-family: var(--font-mono);
        font-size: 0.875rem;
        color: var(--text-tertiary);
    }

    /* é˜…è¯»ç»Ÿè®¡ */
    .article-stats {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
        font-size: 0.8125rem;
        color: var(--text-tertiary);
    }

    .stat-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .stat-badge svg {
        width: 14px;
        height: 14px;
    }

    /* GitHubæ ‡ç­¾æ ·å¼ */
    .article-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .tag {
        display: inline-block;
        padding: 0.375rem 0.875rem;
        border-radius: 1.5rem;
        font-size: 0.8125rem;
        font-weight: 500;
        color: white;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .tag:hover {
        opacity: 0.85;
        transform: translateY(-1px);
    }

    .content-tag {
        display: inline-block;
        padding: 0.375rem 0.875rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 1.5rem;
        font-size: 0.8125rem;
        color: var(--text-secondary);
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .content-tag:hover {
        background: var(--bg-hover);
        border-color: var(--border-hover);
        color: var(--text-primary);
    }

    /* æ–‡ç« å†…å®¹åŒº */
    .content-area {
        font-size: 1rem;
        line-height: 1.8;
        color: var(--text-primary);
    }

    /* Markdown æ ·å¼é€‚é…æš—é»‘æ¨¡å¼ */
    body[data-theme="dark"] .markdown-body {
        color-scheme: dark;
        background-color: transparent !important;
        color: var(--text-primary) !important;
    }

    /* æ–‡ç« å¯¼èˆª */
    .article-navigation {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin: 4rem 0 3rem;
        padding-top: 3rem;
        border-top: 1px solid var(--border-color);
    }

    .nav-item {
        padding: 1.25rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        transition: all 0.2s ease;
    }

    .nav-item:hover {
        background: var(--bg-hover);
        border-color: var(--border-hover);
        transform: translateY(-2px);
    }

    .nav-item.next {
        text-align: right;
    }

    .nav-label {
        display: block;
        font-size: 0.75rem;
        color: var(--text-tertiary);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .nav-title {
        display: block;
        color: var(--text-primary);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9375rem;
        transition: color 0.2s ease;
    }

    .nav-title:hover {
        color: var(--text-secondary);
    }

    /* ç›¸å…³æ–‡ç«  */
    .related-articles {
        margin: 3rem 0;
        padding: 1.5rem;
        background: var(--bg-secondary);
        border-radius: 0.75rem;
        border: 1px solid var(--border-color);
    }

    .related-articles h3 {
        font-size: 1rem;
        font-weight: 500;
        margin-bottom: 1rem;
        color: var(--text-primary);
    }

    .related-list {
        list-style: none;
        padding: 0;
    }

    .related-list li {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
        animation: slideIn 0.3s ease;
    }

    .related-list li:last-child {
        border-bottom: none;
    }

    .related-list a {
        color: var(--text-primary);
        text-decoration: none;
        font-size: 0.9375rem;
        transition: color 0.2s ease;
        flex: 1;
    }

    .related-list a:hover {
        color: var(--text-secondary);
    }

    .related-date {
        font-family: var(--font-mono);
        font-size: 0.8125rem;
        color: var(--text-tertiary);
        margin-left: 1rem;
    }

    /* è¯„è®ºåŒº */
    .comment-section {
        margin-top: 4rem;
        padding-top: 3rem;
        border-top: 1px solid var(--border-color);
    }

    .comment-section h3 {
        font-size: 1.125rem;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
    }

    /* å®æ—¶è¯„è®ºæµ */
    .live-comments {
        margin-top: 1rem;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1rem;
    }

    .live-comment {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        animation: fadeIn 0.3s ease;
    }

    .live-comment:last-child {
        border-bottom: none;
    }

    .live-comment .comment-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.25rem;
        font-size: 0.8125rem;
        color: var(--text-tertiary);
    }

    .live-comment .comment-author {
        font-weight: 500;
        color: var(--text-primary);
    }

    .live-comment .comment-content {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    /* è¿”å›æŒ‰é’® */
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        padding: 0.5rem 0.875rem;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .back-link:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    /* ä»£ç å—æ ·å¼ */
    .markdown-body .codehilite,
    .markdown-body pre {
        position: relative;
        background: var(--bg-secondary) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 0.5rem !important;
        padding: 1rem !important;
        margin: 1rem 0 !important;
        overflow-x: auto;
        font-size: 0.875rem !important;
        line-height: 1.6 !important;
    }

    /* ä»£ç å¤åˆ¶æŒ‰é’® */
    .copy-code-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        cursor: pointer;
        opacity: 0;
        transition: all 0.2s;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .codehilite:hover .copy-code-btn,
    pre:hover .copy-code-btn {
        opacity: 1;
    }

    .copy-code-btn:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .copy-code-btn.copied {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }

    /* å›¾ç‰‡æ ·å¼ */
    .markdown-body .content-area img {
        cursor: zoom-in;
        border-radius: 0.5rem;
        transition: opacity 0.3s, transform 0.3s;
        max-width: 100%;
        height: auto;
    }

    /* åŠ¨ç”» */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
        .article-title-text {
            font-size: 1.75rem;
        }

        .article-navigation {
            grid-template-columns: 1fr;
        }

        .nav-item.next {
            text-align: left;
        }

        .related-list li {
            flex-direction: column;
            gap: 0.25rem;
        }

        .related-date {
            margin-left: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<a href="../index.html" class="back-link">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
    è¿”å›é¦–é¡µ
</a>

<article>
    <header class="article-header">
        <h1 class="article-title-text">{{issue.title}}</h1>

        <div class="article-meta">
            <time class="post-date">{{issue.created_at.strftime('%B %d, %Y')}}</time>
        </div>

        <!-- å®æ—¶é˜…è¯»ç»Ÿè®¡ -->
        <div class="article-stats">
            <span class="stat-badge">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="2"></circle>
                    <path d="M22 12c-2.667 4.667-6 7-10 7s-7.333-2.333-10-7c2.667-4.667 6-7 10-7s7.333 2.333 10 7z"></path>
                </svg>
                <span id="view-count">åŠ è½½ä¸­...</span>
            </span>
            <span class="stat-badge">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span id="visitor-count">åŠ è½½ä¸­...</span>
            </span>
        </div>

        <div class="article-tags">
            {% for l in labels_data %}
            <a href="../tags/{{l.safe_name}}.html" class="tag" style="background-color: #{{l.color}};">
                {{l.name}}
            </a>
            {% endfor %}

            {% if content_tags %}
            {% for tag in content_tags %}
            {% if tag.safe_name %}
            <a href="../tags/{{tag.safe_name}}.html" class="content-tag">
                {{tag.name}}
            </a>
            {% else %}
            <span class="content-tag">{{tag.name}}</span>
            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </header>

    <div class="markdown-body content-area">
        {{content|safe}}
    </div>
</article>

<!-- æ–‡ç« å¯¼èˆª -->
{% if prev_article or next_article %}
<nav class="article-navigation">
    {% if prev_article %}
    <div class="nav-item">
        <span class="nav-label">â† ä¸Šä¸€ç¯‡</span>
        <a href="article-{{prev_article.number}}.html" class="nav-title">{{prev_article.title}}</a>
    </div>
    {% else %}
    <div></div>
    {% endif %}

    {% if next_article %}
    <div class="nav-item next">
        <span class="nav-label">ä¸‹ä¸€ç¯‡ â†’</span>
        <a href="article-{{next_article.number}}.html" class="nav-title">{{next_article.title}}</a>
    </div>
    {% endif %}
</nav>
{% endif %}

<!-- ç›¸å…³æ–‡ç« æµå¼åŠ è½½å®¹å™¨ -->
<aside class="related-articles">
    <h3>ç›¸å…³æ–‡ç« </h3>
    <ul class="related-list" id="related-articles-list">
        <li class="loading-item">åŠ è½½ç›¸å…³æ–‡ç« ä¸­...</li>
    </ul>
</aside>

<!-- å®æ—¶è¯„è®ºæµ -->
<section class="comment-section">
    <h3>ğŸ’¬ å®æ—¶è¯„è®º</h3>
    <div class="live-comments" id="live-comments">
        <div class="live-comment loading">è¿æ¥ä¸­...</div>
    </div>
    
    <!-- Walineè¯„è®ºåŒº -->
    <div id="waline-container"></div>
</section>

<!-- æµå¼è§£æè„šæœ¬ -->
<script type="module">
    import { parse } from 'https://unpkg.com/jsonriver?module';

    const API_BASE = 'https://api.134688.xyz'; // æ›¿æ¢ä¸ºä½ çš„APIåœ°å€
    const articleNumber = {{issue.number}};

    // ========== å®æ—¶é˜…è¯»ç»Ÿè®¡ ==========
    async function streamArticleStats() {
        try {
            const response = await fetch(`${API_BASE}/articles/${articleNumber}/stats/stream`);
            const stream = parse(response.body.pipeThrough(new TextDecoderStream()));
            
            for await (const stat of stream) {
                if (stat.type === 'views') {
                    document.getElementById('view-count').textContent = stat.count + 'æ¬¡é˜…è¯»';
                } else if (stat.type === 'visitors') {
                    document.getElementById('visitor-count').textContent = stat.count + 'äººåœ¨çº¿';
                }
            }
        } catch (error) {
            console.log('ç»Ÿè®¡æµæ–­å¼€:', error);
            setTimeout(streamArticleStats, 5000);
        }
    }

    // ========== ç›¸å…³æ–‡ç« æµå¼åŠ è½½ ==========
    async function loadRelatedArticles() {
        const container = document.getElementById('related-articles-list');
        container.innerHTML = ''; // æ¸…ç©ºåŠ è½½æç¤º
        
        try {
            const response = await fetch(`${API_BASE}/articles/${articleNumber}/related/stream`);
            const stream = parse(response.body.pipeThrough(new TextDecoderStream()));
            
            for await (const article of stream) {
                const li = document.createElement('li');
                li.style.animation = 'slideIn 0.3s ease';
                li.innerHTML = `
                    <a href="article-${article.number}.html">${escapeHtml(article.title)}</a>
                    <span class="related-date">${article.date}</span>
                `;
                container.appendChild(li);
            }
        } catch (error) {
            console.error('åŠ è½½ç›¸å…³æ–‡ç« å¤±è´¥:', error);
            container.innerHTML = '<li class="error-item">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</li>';
        }
    }

    // ========== å®æ—¶è¯„è®ºæµ ==========
    async function streamLiveComments() {
        const container = document.getElementById('live-comments');
        
        try {
            const response = await fetch(`${API_BASE}/articles/${articleNumber}/comments/stream`);
            const stream = parse(response.body.pipeThrough(new TextDecoderStream()));
            
            container.innerHTML = ''; // æ¸…ç©ºè¿æ¥æç¤º
            
            for await (const comment of stream) {
                const commentEl = document.createElement('div');
                commentEl.className = 'live-comment';
                commentEl.innerHTML = `
                    <div class="comment-meta">
                        <span class="comment-author">${escapeHtml(comment.author)}</span>
                        <span class="comment-time">${comment.time}</span>
                    </div>
                    <div class="comment-content">${escapeHtml(comment.content)}</div>
                `;
                
                container.insertBefore(commentEl, container.firstChild);
                
                // é™åˆ¶æ˜¾ç¤ºæ•°é‡
                while (container.children.length > 20) {
                    container.removeChild(container.lastChild);
                }
            }
        } catch (error) {
            console.log('è¯„è®ºæµæ–­å¼€:', error);
            setTimeout(streamLiveComments, 5000);
        }
    }

    // ========== å·¥å…·å‡½æ•° ==========
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ========== åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', () => {
        streamArticleStats();
        loadRelatedArticles();
        streamLiveComments();

        // å›¾ç‰‡æ‡’åŠ è½½
        const lazyImages = document.querySelectorAll('img[data-src]');
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.add('img-loaded');
                        imageObserver.unobserve(img);
                    }
                });
            });

            lazyImages.forEach(img => imageObserver.observe(img));
        } else {
            lazyImages.forEach(img => {
                img.src = img.dataset.src;
            });
        }

        // ä»£ç å—å¤åˆ¶åŠŸèƒ½
        document.querySelectorAll('.codehilite, pre').forEach(codeBlock => {
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-code-btn';
            copyBtn.textContent = 'å¤åˆ¶';
            
            codeBlock.style.position = 'relative';
            codeBlock.appendChild(copyBtn);
            
            copyBtn.addEventListener('click', async () => {
                const code = codeBlock.querySelector('code')?.textContent || codeBlock.textContent;
                try {
                    await navigator.clipboard.writeText(code);
                    copyBtn.textContent = 'å·²å¤åˆ¶ âœ“';
                    copyBtn.classList.add('copied');
                    setTimeout(() => {
                        copyBtn.textContent = 'å¤åˆ¶';
                        copyBtn.classList.remove('copied');
                    }, 2000);
                } catch {
                    copyBtn.textContent = 'å¤åˆ¶å¤±è´¥';
                    setTimeout(() => {
                        copyBtn.textContent = 'å¤åˆ¶';
                    }, 2000);
                }
            });
        });
    });
</script>

<!-- Waline è¯„è®ºç³»ç»Ÿ -->
<script type="module">
    import { init } from 'https://cdn.jsdelivr.net/npm/@waline/client@3/dist/waline.min.js';

    const waline = init({
        el: '#waline-container',
        serverURL: 'https://waline.134688.xyz',
        lang: 'zh-CN',
        locale: {
            placeholder: 'ç•™ä¸‹ä½ çš„è¶³è¿¹å§ï½ (æ”¯æŒ Markdown è¯­æ³•)',
        },
        login: 'disable',
        dark: document.body.getAttribute('data-theme') === 'dark',
        meta: ['nick'],
        requiredMeta: ['nick'],
        pageSize: 10,
        wordLimit: 0,
        pageview: true,
        comment: true,
        copyright: false,
        reaction: true,
        emoji: [
            'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/weibo',
        ],
    });

    // ä¿å­˜å®ä¾‹ä¾›ä¸»é¢˜åˆ‡æ¢ä½¿ç”¨
    window.walineInstance = waline;
</script>

<!-- Medium-zoom å›¾ç‰‡ç¼©æ”¾ -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script>
<script>
    mediumZoom('.content-area img', {
        margin: 24,
        background: 'rgba(0, 0, 0, 0.9)',
        scrollOffset: 0,
    });
</script>
{% endblock %}
